<div class="flex flex-col gap-4" *ngIf="assignment$ | async as assignment">
	<div class="mb-4 grid">
		<div>
			<span class="text-light">Max. {{ "Property.Assignment.Points" | translate }}: </span>
			<span class="font-bold">{{ assignment.points }}</span>
		</div>
		<div *ngIf="assignment.bonusPoints | number">
			<span class="text-light">{{ "Property.Assignment.BonusPoints" | translate }}: </span>
			<span class="font-bold">{{ assignment.bonusPoints }}</span>
		</div>
	</div>

	<button mat-flat-button color="accent" class="w-fit" [disabled]="form.invalid">
		{{ "Action.Create" | translate }} (not implemented)
	</button>

	<mat-tab-group
		color="accent"
		animationDuration="0"
		(selectedIndexChange)="selectedTabChanged($event)"
	>
		<mat-tab [label]="'Domain.RegisteredGroups' | translate">
			<ng-container
				*ngTemplateOutlet="
					formTemplate;
					context: { controls: form.controls, display: groupDisplay }
				"
			></ng-container>
		</mat-tab>
		<mat-tab [label]="'Domain.Participants' | translate">
			<ng-container
				*ngTemplateOutlet="
					formTemplate;
					context: { controls: form.controls, display: studentDisplay }
				"
			></ng-container>
		</mat-tab>
	</mat-tab-group>
</div>

<ng-template #formTemplate let-controls="controls" let-display="display">
	<div class="py-4" *ngIf="(isLoading$ | async) === false; else loadingSpinner">
		<form class="flex flex-col justify-between divide-y rounded bg-card-bg shadow">
			<div class="text-light grid grid-cols-6 py-4 text-xs font-bold">
				<div class="pl-4">{{ "Domain.Group" | translate }}</div>
				<div class="">{{ "Domain.Points" | translate }}</div>
				<div class="">{{ "Property.Assignment.Comment" | translate }}</div>
			</div>
			<div
				class="grid grid-cols-6"
				*ngFor="let control of controls"
				[formGroup]="$any(control)"
			>
				<div class="col-span-1 min-w-fit self-center pl-4">
					<div class="py-2">
						<!-- This container renders either the group or student -->
						<ng-container
							*ngTemplateOutlet="display; context: { $implicit: control }"
						></ng-container>
					</div>
				</div>
				<input
					class="col-span-1 my-auto h-fit w-24 rounded bg-color-bg p-1"
					type="number"
					formControlName="achievedPoints"
				/>
				<div class="col-span-4 py-2 pr-2">
					<textarea
						class="h-full w-full rounded bg-color-bg p-1"
						formControlName="comment"
					></textarea>
				</div>
			</div>
		</form>
	</div>
</ng-template>

<ng-template #groupDisplay let-control>
	<div class="font-bold">
		{{ control.get("entity")?.value.name }}
	</div>
	<div class="grid py-1">
		<span
			class="text-light text-xs"
			*ngFor="let member of control.get('entity')?.value.members"
			>{{ member.displayName }}</span
		>
	</div>
</ng-template>

<ng-template #studentDisplay let-control>
	<div class="font-bold">
		{{ control.get("entity")?.value.displayName }}
	</div>
</ng-template>

<ng-template #loadingSpinner>
	<div class="w-full p-8">
		<mat-progress-spinner
			class="mx-auto"
			diameter="64"
			mode="indeterminate"
		></mat-progress-spinner>
	</div>
</ng-template>
